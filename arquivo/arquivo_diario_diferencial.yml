---

- hosts: backup
  become: true
  vars:
    ansible_python_interpreter: /usr/bin/python3
  gather_facts: false
  tasks:
    - name: Montar partição INTRA
      mount:
        src: 10.6.45.202:/backup2/FILESERVER/SRV_PERSEFONE3_STI/SRV_PERSEFONE3_STI
        path: /mnt/SRV_PERSEFONE3_STI
        opts: rw
        fstype: nfs
        state: ephemeral
      become: true

    - name: Montar partição INTRA
      mount:
        src: nas3.dpe-go.intra:/diario/{{ item }}
        path: /mnt/{{ item }}
        opts: rw
        fstype: nfs
        state: ephemeral
      become: true
      loop:
        - seg
        - ter
        - qua
        - qui
        - sex
        - sab

    - name: Executar diff
      command: diff /mnt/SRV_PERSEFONE3_STI/ /mnt/{{ item }}/
      register: diff_result
      ignore_errors: true
      loop:
        - seg
        - ter
        - qua
        - qui
        - sex
        - sab

    - name: Copiar arquivos PERSEFONE3_STI
      copy:
        src: /mnt/SRV_PERSEFONE3_STI/
        dest: "/mnt/seg"
        remote_src: true
      when: diff_result.results[0].rc != "0"

    - name: Copiar arquivos PERSEFONE3_STI
      copy:
        src: /mnt/SRV_PERSEFONE3_STI/
        dest: "/mnt/ter"
        remote_src: true
      when: diff_result.results[1].rc != "1"

    - name: Copiar arquivos PERSEFONE3_STI
      copy:
        src: /mnt/SRV_PERSEFONE3_STI/
        dest: "/mnt/qua"
        remote_src: true
      when: diff_result.results[2].rc != "2"

    - name: Copiar arquivos PERSEFONE3_STI
      copy:
        src: /mnt/SRV_PERSEFONE3_STI/
        dest: "/mnt/qui"
        remote_src: true
      when: diff_result.results[3].rc != "3"

    - name: Copiar arquivos PERSEFONE3_STI
      copy:
        src: /mnt/SRV_PERSEFONE3_STI/
        dest: "/mnt/sex"
        remote_src: true
      when: diff_result.results[4].rc != "4"

    - name: Copiar arquivos PERSEFONE3_STI
      copy:
        src: /mnt/SRV_PERSEFONE3_STI/
        dest: "/mnt/sab"
        remote_src: true
      when: diff_result.results[5].rc != "5"

    - mount:
        path: /mnt/{{ item.dst }}
        state: unmounted
      loop:
        - /mnt/SRV_PERSEFONE3_STI/
        - /mnt/seg
        - /mnt/ter
        - /mnt/qua
        - /mnt/qui
        - /mnt/sex
        - /mnt/sab
